# Implementation Plan

- [x] 1. 設定項目とバリデーションを連続モード対応に強化する
- [x] 1.1 連続ヒント関連の設定を既定値とともに公開する
  - `continuousHintMode`, `recenterCommand`, `maxContinuousJumps` の既定値を明示し、既存設定との整合性を維持する
  - ユーザー設定とのマージ時に未指定項目へフォールバック値が適用されることを確認する
  - 連続モードが無効な場合は従来動作を変えないことを確認する
  - _Requirements: R1.3, R4.1_
- [x] 1.2 設定検証ロジックを拡張して入力不備を防止する
  - `continuousHintMode` を真偽値として検証し、不明値は拒否する
  - `recenterCommand` が空文字列や空白のみの場合は警告してフォールバックを適用する
  - `maxContinuousJumps` が 1 未満の場合に警告しデフォルトへ戻す制御を追加する
  - _Requirements: R4.1, R4.2, R4.3_
- [x] deno check で静的解析エラーが出ないことを確認する
- [x] deno -A test {{対象テスト}} で既存テストがすべて通過することを確認する

- [x] 2. 連続ヒントモードの状態管理を Core に追加する
- [x] 2.1 連続ジャンプ用の状態フィールドと初期化処理を実装する
  - 連続モードの有効化フラグ、最終ジャンプ先のバッファ情報、ジャンプ回数カウンターを Core 内で保持する
  - ループ開始時にカウンターを初期化し、バッファ切り替え時は即座にリセットする
  - 無効化された際には状態を完全にクリアし既存の単発モードへ戻す
  - _Requirements: R1.1, R1.4, R3.3_
- [x] 2.2 ジャンプ後処理を共通ハンドラに集約する
  - 単一文字ジャンプ、タイムアウト、自動選択など既存フローから共通ハンドラを呼び出す
  - ジャンプ成功時に連続モードを継続させるか終了させるかを判定する分岐を整備する
  - 共通ハンドラ内でカウンター更新と安全装置チェックを行い、条件に応じてループを終了させる
  - _Requirements: R1.2, R3.2, R3.4_
- [x] deno check で静的解析エラーが出ないことを確認する
- [x] deno -A test {{対象テスト}} で既存テストがすべて通過することを確認する

- [x] 3. 再センタリングとヒント再描画のループ処理を実装する
- [x] 3.1 再センタリングコマンド実行のためのヘルパーを追加する
  - `recenterCommand` を取得し Denops 経由で実行するヘルパーを作成する
  - 実行失敗時はログを残して連続モードを停止し、操作系の安全性を確保する
  - カスタムコマンド設定時も意図した位置へカーソルが移動することを保証する
  - _Requirements: R2.1, R2.3_
- [x] 3.2 ヒント再描画サイクルを組み込みループを完結させる
  - 再センタリング後に最新バッファ内容でヒントを再生成し描画する
  - キャッシュ再利用を行いながら描画処理の呼び出し回数を最小化する
  - ループ継続時はヒント表示状態を正しく維持し、終了時は表示を確実に閉じる
  - _Requirements: R1.2, R2.2, R2.4_
- [x] deno check で静的解析エラーが出ないことを確認する
- [x] deno -A test {{対象テスト}} で既存テストがすべて通過することを確認する

- [x] 4. ループ終了条件とセーフティを実装する
- [x] 4.1 無効キー入力・Esc で連続モードを停止させる
  - 無効キーや Esc を検出した際にヒントを非表示にし、カウンターと状態をリセットする
  - 通常のキー処理へ制御を返す前に連続モードのフラグを確実に落とす
  - 終了時のメッセージ表示や視覚的フィードバックを既存挙動と揃える
  - _Requirements: R3.1_
- [x] 4.2 最大ジャンプ数とバッファ境界による安全制御を追加する
  - ジャンプ回数が `maxContinuousJumps` に到達した際に警告を表示し連続モードを停止する
  - 別バッファ／別ウィンドウへの移動を検出してループを終了し、カウンターを初期化する
  - 過剰ループ防止のため、強制停止時にヒント表示も確実に閉じる
  - _Requirements: R3.2, R3.3_
- [x] deno check で静的解析エラーが出ないことを確認する
- [x] deno -A test {{対象テスト}} で既存テストがすべて通過することを確認する

- [x] 5. 既存フローとの統合と回帰確認を行う
- [x] 5.1 waitForUserInput 系処理へ連続モードロジックを統合する
  - 既存の待機ループ各分岐に共通ハンドラを組み込み、連続モード有効時のみ発火させる
  - 無効化状態では従来フローをそのまま通過することを確認する
  - 主要モーションと複数入力シナリオでループが正しく継続・終了することを手動検証する
  - _Requirements: R1.1, R1.2, R1.3, R3.1_
- [x] 5.2 パフォーマンス計測とログの整合性を整える
  - 連続モードでも `showHints` / `hideHints` の計測が正確に記録されるようにする
  - デバッグログが有効な場合にカウンター情報が出力されるよう更新する
  - 既存のキャッシュクリアやデバッグコマンドが連続モードと干渉しないことを確認する
  - _Requirements: R2.4, R3.2, R4.4_
- [x] deno check で静的解析エラーが出ないことを確認する
- [x] deno -A test {{対象テスト}} で既存テストがすべて通過することを確認する

- [x] 6. 自動テストと受け入れ確認を強化する
- [x] 6.1 ユニットテストで連続モードの振る舞いを検証する
  - カウンターリセット、上限到達、再センタリング失敗時の挙動を網羅するテストを追加する
  - 連続モード無効時に既存テストが通過することを確認する
  - `recenterCommand` のカスタマイズが正しく反映されるモックテストを実装する
  - _Requirements: R2.1, R2.3, R3.2, R4.4_
- [x] 6.2 統合テストと Vimscript テストでループ全体を確認する
  - Neovim/Vim テスト環境で複数ジャンプを連続実行し、視覚表示と終了条件を検証する
  - 無効キー入力や Esc を挟んだシナリオを追加してループ終了を確認する
  - パフォーマンステストで連続モードが既存ベンチマークを逸脱しないことを確認する
  - _Requirements: R1.1, R1.2, R2.2, R3.1, R3.2_
- [x] deno check で静的解析エラーが出ないことを確認する
- [x] deno -A test {{対象テスト}} で既存テストがすべて通過することを確認する
